<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ODE Master Generators • Control Panel</title>

  <!-- React (UMD), Babel for JSX, Axios -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.26.2/babel.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.7/axios.min.js" crossorigin="anonymous"></script>

  <!-- Optional config injected by server (if you serve /config.js) -->
  <script src="/config.js" defer></script>

  <style>
    :root{
      --bg1:#7367f0; --bg2:#a86bd8;
      --surface:#fff; --surface-2:#f6f7fb;
      --text:#111827; --muted:#6b7280;
      --primary:#2563eb; --primary-600:#1e40af;
      --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --ring: 0 0 0 3px rgba(37,99,235,.15);
      --shadow: 0 8px 24px rgba(0,0,0,.08);
      --border:#e5e7eb;
      font-synthesis-weight: none;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      min-height:100vh;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
    }
    .wrap{max-width:1280px;margin:0 auto;padding:20px}
    .card{background:var(--surface); border-radius:14px; box-shadow:var(--shadow)}
    .hdr{display:flex; align-items:center; justify-content:space-between; padding:18px 22px; gap:16px}
    .title{display:flex; align-items:center; gap:14px; font-weight:800; font-size:22px}
    .title .emoji{font-size:22px}
    .hdr-right{display:flex; gap:10px; align-items:center}
    .pill{border-radius:999px; background:#f3f4f6; padding:8px 12px; font-size:14px; color:#111}
    .pill.ok{background:rgba(16,185,129,.12); color:#065f46}
    .pill.bad{background:rgba(239,68,68,.12); color:#7f1d1d}
    .pill.neutral{background:#f3f4f6; color:#374151}
    .btn{border:0; background:var(--primary); color:#fff; border-radius:10px; height:40px; padding:0 14px; cursor:pointer; font-weight:600}
    .btn:hover{background:var(--primary-600)}
    .layout{display:grid; grid-template-columns:260px 1fr; gap:20px; margin-top:20px}
    .sidebar{padding:14px}
    .nav-item{display:flex; align-items:center; gap:12px; padding:12px 14px; border-radius:10px; cursor:pointer; font-weight:600; color:#111}
    .nav-item:hover{background:var(--surface-2)}
    .nav-item.active{background:var(--primary); color:#fff}
    .main{padding:20px}
    h2{margin:0 0 16px 0}
    .grid{display:grid; gap:14px; grid-template-columns:repeat(12,1fr)}
    .field{display:flex; flex-direction:column; gap:8px}
    .field label{font-weight:700; font-size:14px}
    select,input,textarea{
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:15px; background:#fff;
    }
    select:focus,input:focus,textarea:focus{outline:none; box-shadow:var(--ring); border-color:var(--primary)}
    .row{display:flex; gap:10px; align-items:center}
    .muted{color:var(--muted)}
    .divider{height:1px;background:#eef0f6;margin:18px 0}
    .result{border:1px solid var(--border); border-radius:12px; padding:14px; background:#fff}
    .badge{padding:4px 8px; font-weight:700;border-radius:6px;font-size:12px}
    .badge.ok{background:rgba(16,185,129,.12); color:#047857}
    .badge.no{background:rgba(239,68,68,.12); color:#991b1b}
    .notice{padding:12px;border-radius:12px;border:1px solid #fde68a;background:#fffbeb;color:#92400e}
    .error{padding:12px;border-radius:12px;border:1px solid #fecaca;background:#fef2f2;color:#991b1b}
    .success{padding:12px;border-radius:12px;border:1px solid #bbf7d0;background:#f0fdf4;color:#065f46}
    .flex{display:flex; gap:14px; align-items:center}
    .w-3{grid-column:span 3}
    .w-4{grid-column:span 4}
    .w-6{grid-column:span 6}
    .w-12{grid-column:span 12}
    @media (max-width: 960px){
      .layout{grid-template-columns:1fr}
      .w-3,.w-4,.w-6,.w-12{grid-column:span 12}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="root" class="card"></div>
  </div>

  <script type="text/babel">
  const {useState, useEffect, useRef} = React;

  // ---------- Utilities ----------
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  const lc = {
    get(k, def){ try{ const v = localStorage.getItem(k); return v==null ? def : JSON.parse(v); }catch{ return def; } },
    set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
  };
  function isHTMLPayload(res){
    const ct = (res.headers?.['content-type'] || '').toLowerCase();
    if (ct && !ct.includes('application/json')) {
      if (typeof res.data === 'string' && /<!doctype|<html/i.test(res.data)) return true;
    }
    return false;
  }

  // ---------- API Client ----------
  class API {
    constructor({base, key, ws=true}){
      this.base = base?.replace(/\/+$/,'') || window.location.origin;
      this.key  = key || '';
      this.ws   = !!ws;
      this.prefix = null; // '/api' or '/api/v1'
      this.client = axios.create({
        baseURL: this.base,
        timeout: 15000,
        headers: {
          'X-API-Key': this.key,
          'Content-Type':'application/json'
        },
        withCredentials: false
      });
    }

    setConfig({base, key, ws}){
      this.base = base?.replace(/\/+$/,'') || this.base;
      this.key  = key ?? this.key;
      this.ws   = ws ?? this.ws;
      this.client = axios.create({
        baseURL: this.base,
        timeout: 15000,
        headers:{ 'X-API-Key': this.key, 'Content-Type':'application/json' }
      });
    }

    async _req(method, url, {params,data}={}){
      const res = await this.client.request({method,url,params,data});
      if (isHTMLPayload(res)) {
        const msg = `Expected JSON but got HTML from ${this.base}${url}.
This usually means your SPA fallback is intercepting API routes.
Move the GUI mount AFTER your API routes.`;
        const err = new Error(msg);
        err.response = res;
        throw err;
      }
      return res.data;
    }

    async health(){
      // Health normally doesn't need key, but header is harmless
      return this._req('GET','/health');
    }

    async detectPrefix(){
      if (this.prefix) return this.prefix;
      const candidates = ['/api','/api/v1'];
      for (const p of candidates){
        try{
          const data = await this._req('GET', `${p}/generators`);
          // must be an object listing generators
          if (data && (Array.isArray(data.all) || data.linear || data.nonlinear)) {
            this.prefix = p;
            return p;
          }
        }catch(_){} // keep trying
      }
      // one more try with functions for servers that protect /generators
      for (const p of candidates){
        try{
          const data = await this._req('GET', `${p}/functions`);
          if (data && (Array.isArray(data.functions) || data.count >= 0)){
            this.prefix = p;
            return p;
          }
        }catch(_){}
      }
      throw new Error('Could not detect API prefix. Make sure /api/* or /api/v1/* endpoints are reachable and not intercepted by the SPA.');
    }

    async generators(){
      const p = await this.detectPrefix();
      return this._req('GET', `${p}/generators`);
    }
    async functions(){
      const p = await this.detectPrefix();
      return this._req('GET', `${p}/functions`);
    }
    async generate(body){
      const p = await this.detectPrefix();
      return this._req('POST', `${p}/generate`, {data:body});
    }
    async batchGenerate(body){
      const p = await this.detectPrefix();
      return this._req('POST', `${p}/batch_generate`, {data:body});
    }
    async verify(body){
      const p = await this.detectPrefix();
      return this._req('POST', `${p}/verify`, {data:body});
    }
    async jobs(params){
      const p = await this.detectPrefix();
      return this._req('GET', `${p}/jobs`, {params});
    }
    async job(id){
      const p = await this.detectPrefix();
      return this._req('GET', `${p}/jobs/${id}`);
    }
    async cancelJob(id){
      const p = await this.detectPrefix();
      return this._req('DELETE', `${p}/jobs/${id}`);
    }
    async datasets(){
      const p = await this.detectPrefix();
      return this._req('GET', `${p}/datasets`);
    }
    async models(){
      const p = await this.detectPrefix();
      return this._req('GET', `${p}/ml/models`);
    }
    async stats(){
      const p = await this.detectPrefix();
      return this._req('GET', `${p}/stats`);
    }
  }

  // ---------- App ----------
  const DEFAULTS = {
    // will be overwritten by window.ODE_CONFIG if present
    API_BASE: window.location.origin,
    API_KEY: 'dev-key',
    WS: true
  };

  function useConfig(){
    const injected = (window.ODE_CONFIG || {});
    const initial = {
      base: lc.get('ode.api.base', injected.API_BASE ?? DEFAULTS.API_BASE),
      key:  lc.get('ode.api.key',  injected.API_KEY  ?? DEFAULTS.API_KEY),
      ws:   lc.get('ode.api.ws',   injected.WS       ?? DEFAULTS.WS)
    };
    const [cfg, setCfg] = useState(initial);
    const save = (c)=>{
      lc.set('ode.api.base', c.base);
      lc.set('ode.api.key', c.key);
      lc.set('ode.api.ws', c.ws);
      setCfg(c);
    };
    const reset = ()=>{
      const c = {base: DEFAULTS.API_BASE, key: DEFAULTS.API_KEY, ws: DEFAULTS.WS};
      lc.set('ode.api.base', c.base); lc.set('ode.api.key', c.key); lc.set('ode.api.ws', c.ws);
      setCfg(c);
    };
    return [cfg, save, reset];
  }

  function StatusPill({label, state}){
    // state: 'ok'|'bad'|'neutral'
    const cls = state==='ok'?'ok': state==='bad'?'bad':'neutral';
    return <span className={`pill ${cls}`}>{label}</span>;
  }

  function App(){
    const [cfg, saveCfg] = useConfig();
    const [view, setView] = useState('generator');
    const apiRef = useRef(new API({base:cfg.base, key:cfg.key, ws:cfg.ws}));
    const [apiState, setApiState] = useState({status:'checking', ml:false, cache:false, ws:cfg.ws, error:null});

    const applyCfg = (c)=>{
      apiRef.current.setConfig({base:c.base, key:c.key, ws:c.ws});
      saveCfg(c);
      checkHealth(); // refresh banner
    };

    async function checkHealth(){
      setApiState(s=>({...s, status:'checking', error:null}));
      try{
        // small grace: wait for server warmup on Railway
        const h = await apiRef.current.health();
        // Accept either shape:
        const ml = !!(h?.services?.ml_pipeline ?? h?.features?.ml);
        const cache = !!(h?.services?.cache ?? h?.features?.redis);
        setApiState({status:'ok', ml, cache, ws:cfg.ws, error:null});
      }catch(err){
        setApiState({status:'bad', ml:false, cache:false, ws:cfg.ws, error: (err?.message||'Health failed')});
      }
    }

    useEffect(()=>{ checkHealth(); /* eslint-disable-next-line */ },[]);
    useEffect(()=>{ apiRef.current.setConfig(cfg); },[cfg.base, cfg.key, cfg.ws]);

    return (
      <>
        <div className="hdr">
          <div className="title"><span className="emoji">🧪</span> ODE Master Generators <span className="muted" style={{fontWeight:600}}>Control Panel</span></div>
          <div className="hdr-right">
            <StatusPill label={`API: ${apiState.status}`} state={apiState.status==='ok'?'ok':apiState.status==='bad'?'bad':'neutral'} />
            <StatusPill label={`ML: ${apiState.ml?'✓':'✗'}`} state={apiState.ml?'ok':'neutral'} />
            <StatusPill label={`Cache: ${apiState.cache?'✓':'✗'}`} state={apiState.cache?'ok':'neutral'} />
            <StatusPill label={`WS: ${cfg.ws?'✓':'✗'}`} state={cfg.ws?'ok':'neutral'} />
            <button className="btn" onClick={checkHealth}>⟲ Refresh</button>
          </div>
        </div>

        <div className="layout">
          <div className="sidebar card">
            {[
              ['generator','⚡ ODE Generator'],
              ['batch','📦 Batch Generation'],
              ['verify','✓ Verification'],
              ['datasets','💾 Datasets'],
              ['jobs','⚙️ Jobs'],
              ['ml','🤖 ML'],
              ['analytics','📊 Analytics'],
              ['settings','⚙️ Settings'],
            ].map(([id,label])=>(
              <div key={id} className={`nav-item ${view===id?'active':''}`} onClick={()=>setView(id)}>{label}</div>
            ))}
          </div>

          <div className="main card">
            {apiState.status==='bad' && (
              <div className="error">
                <div><strong>API is not reachable.</strong></div>
                <div className="muted" style={{marginTop:6}}>{apiState.error}</div>
                <div style={{marginTop:8}}>Tip: If your FastAPI serves the SPA, mount the GUI <em>after</em> your `/api/*` and `/health` routes so requests don’t return HTML.</div>
              </div>
            )}

            {view==='generator' && <GeneratorView api={apiRef.current} canRun={apiState.status==='ok'} />}
            {view==='batch' && <BatchView api={apiRef.current} canRun={apiState.status==='ok'} />}
            {view==='verify' && <VerifyView api={apiRef.current} canRun={apiState.status==='ok'} />}
            {view==='datasets' && <DatasetsView api={apiRef.current} canRun={apiState.status==='ok'} />}
            {view==='jobs' && <JobsView api={apiRef.current} canRun={apiState.status==='ok'} />}
            {view==='ml' && <MLView api={apiRef.current} canRun={apiState.status==='ok'} />}
            {view==='analytics' && <AnalyticsView api={apiRef.current} canRun={apiState.status==='ok'} />}
            {view==='settings' && <SettingsView cfg={cfg} onSave={applyCfg} onReset={()=>applyCfg({base:DEFAULTS.API_BASE,key:DEFAULTS.API_KEY,ws:DEFAULTS.WS})} />}
          </div>
        </div>
      </>
    );
  }

  // ---------- Views ----------
  function GeneratorView({api, canRun}){
    const [gens,setGens] = useState([]);
    const [funcs,setFuncs] = useState([]);
    const [form,setForm] = useState({generator:'', function:'', count:1, verify:true, parameters:{}});
    const [loading,setLoading]=useState(false);
    const [error,setError]=useState(null);
    const [results,setResults]=useState(null);

    useEffect(()=>{
      let mounted=true;
      (async ()=>{
        try{
          const [g,f] = await Promise.all([api.generators(), api.functions()]);
          const allG = Array.isArray(g?.all) ? g.all
                       : [...Object.keys(g?.linear||{}), ...Object.keys(g?.nonlinear||{})];
          const allF = Array.isArray(f?.functions) ? f.functions : Object.keys(f||{});
          if (mounted){
            setGens(allG||[]);
            setFuncs(allF||[]);
            setForm(s=>({...s, generator: allG?.[0]||'', function: allF?.[0]||''}));
          }
        }catch(err){
          setError(err?.message || 'Failed to load options.');
        }
      })();
      return ()=>{ mounted=false; };
    },[api]);

    const disabled = !canRun || gens.length===0 || funcs.length===0;

    async function submit(){
      setLoading(true); setError(null); setResults(null);
      try{
        const r = await api.generate(form);
        if (r?.job_id){
          // poll job
          let done=false, tries=0;
          while(!done && tries<600){ // up to 10 min if server is busy
            await sleep(1000); tries++;
            const s = await api.job(r.job_id);
            if (s.status==='completed'){ setResults(s.results); done=true; }
            else if (s.status==='failed'){ throw new Error(s.error || 'Job failed'); }
          }
          if (!done) throw new Error('Timed out waiting for job.');
        }else{
          setResults(r);
        }
      }catch(err){ setError(err?.message||'Generation failed.'); }
      finally{ setLoading(false); }
    }

    return (
      <>
        <h2>ODE Generator</h2>
        <div className="grid">
          <div className="field w-6">
            <label>Generator</label>
            <select value={form.generator} onChange={e=>setForm({...form, generator:e.target.value})} disabled={gens.length===0}>
              {gens.length===0 ? <option>Loading…</option> : gens.map(g=><option key={g} value={g}>{g}</option>)}
            </select>
            {gens.length===0 && <div className="muted" style={{fontSize:13}}>Waiting for /api/generators…</div>}
          </div>
          <div className="field w-6">
            <label>Function</label>
            <select value={form.function} onChange={e=>setForm({...form, function:e.target.value})} disabled={funcs.length===0}>
              {funcs.length===0 ? <option>Loading…</option> : funcs.map(f=><option key={f} value={f}>{f}</option>)}
            </select>
          </div>
          <div className="field w-3">
            <label>Count</label>
            <input type="number" min="1" max="100" value={form.count}
                   onChange={e=>setForm({...form, count: Math.max(1, Math.min(100, Number(e.target.value)||1))})}/>
          </div>
          <div className="field w-3">
            <label>Verify</label>
            <select value={String(form.verify)} onChange={e=>setForm({...form, verify: e.target.value==='true'})}>
              <option value="true">Yes</option><option value="false">No</option>
            </select>
          </div>
        </div>

        <div className="row" style={{marginTop:10}}>
          <button className="btn" disabled={disabled||loading} onClick={submit}>
            {loading?'Generating…':'⚡ Generate'}
          </button>
          {disabled && <span className="muted">Select options first.</span>}
        </div>

        <div className="divider"></div>
        {error && <div className="error">{error}</div>}

        {results && (
          <div>
            <h3>Results</h3>
            {Array.isArray(results) ? results.map((r,idx)=><ResultCard key={idx} r={r}/>)
                                     : <ResultCard r={results} />}
          </div>
        )}
      </>
    );
  }

  function ResultCard({r}){
    const verified = !!(r?.verified ?? r?.verification?.verified);
    const method = r?.verification?.method || (verified ? 'substitution' : '-');
    const conf = r?.verification?.confidence;
    return (
      <div className="result" style={{marginBottom:12}}>
        <div className="row" style={{justifyContent:'space-between'}}>
          <div style={{fontWeight:800}}>{r?.generator} • {r?.function}</div>
          <span className={`badge ${verified?'ok':'no'}`}>{verified?'Verified':'Not Verified'}</span>
        </div>
        <div className="muted" style={{marginTop:8, fontFamily:'ui-monospace, SFMono-Regular, Menlo, monospace'}}>
          <div><strong>ODE:</strong> {String(r?.ode ?? r?.ode_symbolic ?? '')}</div>
          <div style={{marginTop:6}}><strong>Solution:</strong> {String(r?.solution ?? r?.solution_symbolic ?? '')}</div>
        </div>
        {conf!=null && <div className="muted" style={{marginTop:6}}>Method: {method}, Confidence: {(conf*100).toFixed(1)}%</div>}
      </div>
    );
  }

  function BatchView({api, canRun}){
    const [gens,setGens]=useState([]); const [funcs,setFuncs]=useState([]);
    const [selG,setSelG]=useState([]); const [selF,setSelF]=useState([]);
    const [samples,setSamples]=useState(5);
    const [verify,setVerify]=useState(true);
    const [save,setSave]=useState(true);
    const [name,setName]=useState('');
    const [msg,setMsg]=useState(null); const [err,setErr]=useState(null);

    useEffect(()=>{ (async ()=>{
      try{
        const [g,f] = await Promise.all([api.generators(), api.functions()]);
        const allG = Array.isArray(g?.all) ? g.all : [...Object.keys(g?.linear||{}), ...Object.keys(g?.nonlinear||{})];
        const allF = Array.isArray(f?.functions) ? f.functions : Object.keys(f||{});
        setGens(allG||[]); setFuncs(allF||[]);
      }catch(e){ setErr(e?.message || 'Failed to load options.'); }
    })(); },[api]);

    async function start(){
      setErr(null); setMsg(null);
      try{
        const body = {
          generators: selG, functions: selF,
          samples_per_combination: samples,
          verify, save_dataset: save,
          dataset_name: name || undefined
        };
        const r = await api.batchGenerate(body);
        setMsg(`Job ${r.job_id} created. Total expected: ${r.total_expected}.`);
      }catch(e){ setErr(e?.message || 'Batch start failed.'); }
    }

    return (
      <>
        <h2>Batch Generation</h2>
        {err && <div className="error">{err}</div>}
        {msg && <div className="success">{msg}</div>}

        <div className="grid">
          <div className="field w-6">
            <label>Generators</label>
            <div className="muted" style={{fontSize:13, marginBottom:6}}>Click to toggle</div>
            <div className="flex" style={{flexWrap:'wrap'}}>
              {gens.map(g=>(
                <button key={g} onClick={()=>setSelG(s=> s.includes(g)? s.filter(x=>x!==g): [...s,g])}
                        className="pill" style={{border: selG.includes(g)?'2px solid #2563eb':'1px solid #e5e7eb', background:'#fff'}}>
                  {g}
                </button>
              ))}
            </div>
          </div>
          <div className="field w-6">
            <label>Functions</label>
            <div className="flex" style={{flexWrap:'wrap'}}>
              {funcs.map(f=>(
                <button key={f} onClick={()=>setSelF(s=> s.includes(f)? s.filter(x=>x!==f): [...s,f])}
                        className="pill" style={{border: selF.includes(f)?'2px solid #2563eb':'1px solid #e5e7eb', background:'#fff'}}>
                  {f}
                </button>
              ))}
            </div>
          </div>
          <div className="field w-3"><label>Samples/Combo</label>
            <input type="number" min="1" max="50" value={samples} onChange={e=>setSamples(Math.max(1,Math.min(50,Number(e.target.value)||5)))} />
          </div>
          <div className="field w-3"><label>Verify</label>
            <select value={String(verify)} onChange={e=>setVerify(e.target.value==='true')}><option value="true">Yes</option><option value="false">No</option></select>
          </div>
          <div className="field w-3"><label>Save dataset</label>
            <select value={String(save)} onChange={e=>setSave(e.target.value==='true')}><option value="true">Yes</option><option value="false">No</option></select>
          </div>
          <div className="field w-3"><label>Dataset name (optional)</label>
            <input value={name} onChange={e=>setName(e.target.value)} placeholder="auto-generated if empty" />
          </div>
        </div>

        <div className="row" style={{marginTop:10}}>
          <button className="btn" disabled={!canRun || selG.length===0 || selF.length===0} onClick={start}>Start Batch</button>
          {(!selG.length || !selF.length) && <span className="muted">Pick at least one generator and function.</span>}
        </div>
      </>
    );
  }

  function VerifyView({api, canRun}){
    const [ode,setOde]=useState('Eq(Derivative(y(x), x, 2) + y(x), sin(x))');
    const [sol,setSol]=useState('sin(x)');
    const [method,setMethod]=useState('substitution');
    const [res,setRes]=useState(null); const [err,setErr]=useState(null);
    async function submit(){
      setErr(null); setRes(null);
      try{
        const r = await api.verify({ode, solution:sol, method});
        setRes(r);
      }catch(e){ setErr(e?.message || 'Verification failed.'); }
    }
    return (
      <>
        <h2>Verification</h2>
        <div className="grid">
          <div className="field w-12"><label>ODE</label><textarea rows="3" value={ode} onChange={e=>setOde(e.target.value)} /></div>
          <div className="field w-12"><label>Solution</label><textarea rows="3" value={sol} onChange={e=>setSol(e.target.value)} /></div>
          <div className="field w-4"><label>Method</label>
            <select value={method} onChange={e=>setMethod(e.target.value)}>
              <option value="substitution">substitution</option>
              <option value="numeric">numeric</option>
              <option value="series">series</option>
            </select>
          </div>
        </div>
        <div className="row" style={{marginTop:10}}>
          <button className="btn" disabled={!canRun || !ode || !sol} onClick={submit}>Verify</button>
        </div>
        <div className="divider"></div>
        {err && <div className="error">{err}</div>}
        {res && (
          <div className={res.verified?'success':'error'}>
            <div><strong>{res.verified?'Verified ✓':'Not Verified ✗'}</strong></div>
            <div>Method: {res.method}</div>
            {res.confidence!=null && <div>Confidence: {(res.confidence*100).toFixed(1)}%</div>}
            {res.error && <div>Error: {res.error}</div>}
          </div>
        )}
      </>
    );
  }

  function DatasetsView({api}){
    const [list,setList]=useState([]); const [err,setErr]=useState(null);
    useEffect(()=>{ (async ()=>{ try{ const r = await api.datasets(); setList(r.datasets||[]); }catch(e){ setErr(e?.message||'Failed'); } })(); },[api]);
    return (
      <>
        <h2>Datasets</h2>
        {err && <div className="error">{err}</div>}
        <div className="grid">
          {list.map(d=>(
            <div key={d.name} className="result w-6">
              <div className="row" style={{justifyContent:'space-between'}}>
                <div style={{fontWeight:800}}>{d.name}</div>
                <div className="muted">{(d.size_bytes/1024).toFixed(1)} KB</div>
              </div>
              <div className="muted" style={{marginTop:6}}>Created: {new Date(d.created_at).toLocaleString()}</div>
            </div>
          ))}
          {list.length===0 && <div className="muted">No datasets found.</div>}
        </div>
      </>
    );
  }

  function JobsView({api}){
    const [filter,setFilter]=useState('all');
    const [jobs,setJobs]=useState([]); const [err,setErr]=useState(null);
    useEffect(()=>{
      let timer; let mounted=true;
      const load = async ()=>{
        try{
          const params = filter==='all'? {} : {status:filter};
          const r = await api.jobs(params);
          if (!mounted) return;
          setJobs(r.jobs || r || []);
        }catch(e){ setErr(e?.message || 'Failed to load jobs.'); }
        timer = setTimeout(load, 2000);
      };
      load();
      return ()=>{ mounted=false; clearTimeout(timer); };
    },[api,filter]);
    return (
      <>
        <h2>Jobs</h2>
        <div className="row" style={{marginBottom:10}}>
          {['all','queued','running','completed','failed'].map(s=>(
            <button key={s} className="pill" style={{border: filter===s?'2px solid #2563eb':'1px solid #e5e7eb', background:'#fff'}} onClick={()=>setFilter(s)}>{s}</button>
          ))}
        </div>
        {err && <div className="error">{err}</div>}
        {jobs.map(j=>(
          <div key={j.job_id} className="result" style={{marginBottom:10}}>
            <div className="row" style={{justifyContent:'space-between'}}>
              <div style={{fontWeight:800}}>{j.job_id}</div>
              <div className="muted">{j.status} • {Math.round(j.progress||0)}%</div>
            </div>
          </div>
        ))}
        {jobs.length===0 && <div className="muted">No jobs.</div>}
      </>
    );
  }

  function MLView({api}){
    const [models,setModels]=useState([]); const [err,setErr]=useState(null);
    useEffect(()=>{ (async ()=>{ try{ const r = await api.models(); setModels(r.models||[]); }catch(e){ setErr(e?.message||'Failed'); } })(); },[api]);
    return (
      <>
        <h2>ML Models</h2>
        {err && <div className="error">{err}</div>}
        <div className="grid">
          {models.map(m=>(
            <div key={m.name} className="result w-6">
              <div className="row" style={{justifyContent:'space-between'}}>
                <div style={{fontWeight:800}}>{m.name}</div>
                <div className="muted">{(m.size_bytes/(1024*1024)).toFixed(2)} MB</div>
              </div>
              <div className="muted" style={{marginTop:6}}>Created: {new Date(m.created_at).toLocaleString()}</div>
            </div>
          ))}
          {models.length===0 && <div className="muted">No models.</div>}
        </div>
      </>
    );
  }

  function AnalyticsView({api}){
    const [s,setS]=useState(null); const [err,setErr]=useState(null);
    useEffect(()=>{
      let mounted=true, timer;
      const load=async()=>{
        try{ const r=await api.stats(); if(mounted) setS(r); }
        catch(e){ setErr(e?.message||'Failed'); }
        timer=setTimeout(load, 5000);
      };
      load(); return ()=>{ mounted=false; clearTimeout(timer); };
    },[api]);
    return (
      <>
        <h2>Analytics</h2>
        {err && <div className="error">{err}</div>}
        {!s && !err && <div className="muted">Loading…</div>}
        {s && (
          <div className="grid">
            <div className="result w-3"><div className="muted">Generated (24h)</div><div style={{fontWeight:800, fontSize:24}}>{s.statistics?.total_generated_24h ?? '-'}</div></div>
            <div className="result w-3"><div className="muted">Verification Rate</div><div style={{fontWeight:800, fontSize:24}}>{s.statistics?.verification_rate!=null ? (s.statistics.verification_rate*100).toFixed(1)+'%' : '-'}</div></div>
            <div className="result w-3"><div className="muted">Active Jobs</div><div style={{fontWeight:800, fontSize:24}}>{s.statistics?.active_jobs ?? '-'}</div></div>
            <div className="result w-3"><div className="muted">Total Jobs</div><div style={{fontWeight:800, fontSize:24}}>{s.statistics?.total_jobs ?? '-'}</div></div>
            <div className="result w-12"><div className="muted">Queue</div><pre style={{margin:0, whiteSpace:'pre-wrap'}}>{JSON.stringify(s.queue_stats, null, 2)}</pre></div>
          </div>
        )}
      </>
    );
  }

  function SettingsView({cfg,onSave,onReset}){
    const [base,setBase]=useState(cfg.base);
    const [key,setKey]=useState(cfg.key);
    const [ws,setWs]=useState(cfg.ws);
    return (
      <>
        <h2>Settings</h2>
        <div className="grid">
          <div className="field w-6"><label>API Base</label><input value={base} onChange={e=>setBase(e.target.value)} placeholder="https://your-api.example.com" /></div>
          <div className="field w-6"><label>API Key (X-API-Key)</label><input value={key} onChange={e=>setKey(e.target.value)} /></div>
          <div className="field w-3"><label>WebSocket</label>
            <select value={String(ws)} onChange={e=>setWs(e.target.value==='true')}><option value="true">true</option><option value="false">false</option></select>
          </div>
        </div>
        <div className="row" style={{marginTop:10}}>
          <button className="btn" onClick={()=>onSave({base,key,ws})}>Save</button>
          <button className="pill" style={{cursor:'pointer'}} onClick={onReset}>Reset</button>
        </div>
        <div className="notice" style={{marginTop:12}}>
          If “API: checking…” never turns green, open the browser DevTools → Network.
          Requests to <code>/health</code> and <code>/api/generators</code> must return JSON, not HTML.
        </div>
      </>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
