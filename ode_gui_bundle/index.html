<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ODE Master Generators — Control Panel</title>

  <!-- Optional runtime config (served by your FastAPI at /config.js) -->
  <script src="/config.js"></script>

  <!-- CDN libs (no build step) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.24.7/babel.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.8/axios.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js" async crossorigin="anonymous"></script>

  <style>
    :root{--primary:#2563eb;--primary-600:#1e40af;--ok:#10b981;--bad:#ef4444;--muted:#6b7280;--soft:#f3f4f6;--border:#e5e7eb;--shadow:0 10px 25px rgba(0,0,0,.08)}
    *{box-sizing:border-box}body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh}
    .app{max-width:1400px;margin:0 auto;padding:20px}
    .header{background:#fff;border-radius:14px;padding:16px 18px;margin-bottom:20px;box-shadow:var(--shadow);display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .brand h1{margin:0;font-size:22px;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .status{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:flex;align-items:center;gap:6px;background:var(--soft);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:13px}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--ok)}
    .btn{display:inline-flex;align-items:center;gap:8px;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff}.btn.primary:hover{background:var(--primary-600)}
    .btn.ghost{background:#fff;border:1px solid var(--border)}
    .layout{display:grid;grid-template-columns:250px 1fr;gap:20px}
    .side{position:sticky;top:20px;align-self:start;background:#fff;border-radius:14px;padding:14px;box-shadow:var(--shadow)}
    .nav .item{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;font-weight:600;color:#111;cursor:pointer}
    .nav .item:hover{background:var(--soft)}.nav .item.active{background:var(--primary);color:#fff}
    .panel{background:#fff;border-radius:14px;padding:18px;box-shadow:var(--shadow);min-height:560px}
    .tabs{display:flex;gap:18px;border-bottom:2px solid var(--border);margin-bottom:12px}
    .tab{background:none;border:none;padding:12px 0;font-weight:700;color:#111;cursor:pointer}
    .tab.active{color:var(--primary);position:relative}
    .tab.active::after{content:"";position:absolute;left:0;right:0;bottom:-2px;height:2px;background:var(--primary)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:14px}
    .group{display:flex;flex-direction:column;gap:6px}
    .label{font-weight:700;font-size:13px;color:#111}
    .input,.select,textarea{width:100%;border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px}
    .muted{color:var(--muted)} .error{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);color:#b91c1c;border-radius:10px;padding:10px 12px}
    .success{background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.25);color:#065f46;border-radius:10px;padding:10px 12px}
    .results{margin-top:16px;background:#fafafa;border:1px solid var(--border);border-radius:12px;padding:14px}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .badge{font-size:12px;border-radius:6px;padding:4px 8px;font-weight:700}
    .ok{background:rgba(16,185,129,.1);color:#047857}.bad{background:rgba(239,68,68,.1);color:#b91c1c}
    .code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:10px;overflow:auto}
    .jobs{display:flex;flex-direction:column;gap:10px}
    .job{display:flex;justify-content:space-between;align-items:center;gap:12px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
    .bar{width:200px;height:8px;background:#eef2ff;border-radius:6px;overflow:hidden}
    .fill{height:100%;background:var(--primary);transition:width .25s}
    @media (max-width:900px){.layout{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const {useEffect,useRef,useState,useMemo,useCallback} = React;

    // -------------- settings --------------
    function loadSettings(){
      const defaults = { API_BASE: window.location.origin, API_KEY: 'dev-key', WS: true };
      const fromServer = window.ODE_CONFIG || {};
      let fromLocal = {};
      try{ fromLocal = JSON.parse(localStorage.getItem('ode_gui_settings') || '{}'); }catch{}
      return {...defaults, ...fromServer, ...fromLocal};
    }

    // -------------- API with robust fallback --------------
    class API {
      constructor(base, key){
        this.base = base.replace(/\/+$/,'');
        this.key  = key;
        this.client = axios.create({
          baseURL: this.base,
          headers: {'X-API-Key': this.key, 'Content-Type':'application/json'},
          timeout: 15000
        });
        // try both roots for every call; first success wins
        this.roots = ['/api','/api/v1'];
      }

      async _call(method, suffix, {params, data, responseType} = {}){
        const errors = [];
        for(const root of this.roots){
          try{
            const url = `${root}${suffix}`;
            const res = await this.client.request({method, url, params, data, responseType});
            return res;
          }catch(err){
            errors.push({
              root, status: err?.response?.status,
              detail: err?.response?.data?.detail || err.message
            });
            // continue and try next root (even on 401/403/404)
          }
        }
        const e = new Error('All API paths failed');
        e.debug = errors;
        throw e;
      }

      async health(){
        // /health is not under /api
        const res = await axios.get(`${this.base}/health`, {timeout: 10000});
        return res.data;
      }

      async generators(){ return (await this._call('get','/generators')).data; }
      async functions(){  return (await this._call('get','/functions')).data; }
      async generate(d){  return (await this._call('post','/generate', {data:d})).data; }
      async batch(d){     return (await this._call('post','/batch_generate', {data:d})).data; }
      async verify(d){    return (await this._call('post','/verify', {data:d})).data; }
      async job(id){      return (await this._call('get', `/jobs/${id}`)).data; }
      async jobs(status){ return (await this._call('get', '/jobs', {params: status?{status}:undefined})).data; }
      async cancel(id){   return (await this._call('delete', `/jobs/${id}`)).data; }
      async datasets(){   return (await this._call('get', '/datasets')).data; }
      async downloadDataset(name, format='jsonl'){
        return (await this._call('get', `/datasets/${encodeURIComponent(name)}/download`, {params:{format}, responseType:'blob'})).data;
      }
      async models(){     return (await this._call('get', '/ml/models')).data; }
      async mlTrain(d){   return (await this._call('post','/ml/train', {data:d})).data; }
      async mlGen(d){     return (await this._call('post','/ml/generate', {data:d})).data; }
      async stats(){      return (await this._call('get','/stats')).data; }
    }

    // -------------- helpers --------------
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const downloadBlob = (blob, name)=>{ const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url); };

    // -------------- app --------------
    function App(){
      const [settings, setSettings] = useState(loadSettings);
      const api = useMemo(()=>new API(settings.API_BASE, settings.API_KEY), [settings.API_BASE, settings.API_KEY]);

      const [health, setHealth] = useState(null);
      const [apiErr, setApiErr] = useState(null);
      const [view, setView] = useState('generator');
      const [wsOk, setWsOk] = useState(false);

      // health
      useEffect(()=>{
        let live=true;
        (async ()=>{
          try{ const h = await api.health(); if(!live) return; setHealth(h); setApiErr(null); }
          catch(e){ if(!live) return; setApiErr(e?.response?.data?.detail || e.message); }
        })();
        const t = setInterval(async ()=>{
          try{ const h = await api.health(); setHealth(h); setApiErr(null); } catch{}
        }, 30000);
        return ()=>{ live=false; clearInterval(t); };
      }, [api]);

      // ws (best-effort)
      useEffect(()=>{
        if(!settings.WS){ setWsOk(false); return; }
        let ws;
        try{
          const wsUrl = settings.API_BASE.replace(/^http/i,'ws') + `/ws/client-${Date.now()}`;
          ws = new WebSocket(wsUrl);
          ws.onopen = ()=>setWsOk(true);
          ws.onclose = ws.onerror = ()=>setWsOk(false);
        }catch{ setWsOk(false); }
        return ()=>{ try{ ws && ws.close(); }catch{} };
      }, [settings.API_BASE, settings.WS]);

      return (
        <div className="app">
          <div className="header">
            <div className="brand">
              <span style={{fontSize:22}}>🔬</span>
              <h1>ODE Master Generators</h1>
              <span className="muted">Control Panel</span>
            </div>
            <div className="status">
              <div className="pill">
                <span className="dot" style={{background: (health?.status==='healthy') ? '#10b981' : '#ef4444'}}></span>
                <span>API: {health?.status || (apiErr ? 'error' : 'checking…')}</span>
              </div>
              <div className="pill">ML: {health?.services?.ml_pipeline ? '✓':'✗'}</div>
              <div className="pill">Cache: {health?.services?.cache ? '✓':'✗'}</div>
              <div className="pill">WS: {settings.WS ? (wsOk?'✓':'…') : 'off'}</div>
              <button className="btn ghost" onClick={()=>setView('settings')}>⚙️ Settings</button>
              <button className="btn primary" onClick={()=>window.location.reload()}>↻ Refresh</button>
            </div>
          </div>

          {apiErr && (
            <div className="error" style={{margin:'0 0 16px'}}>
              <b>API error:</b> {String(apiErr)}. Check <b>Settings</b> (API Base & API Key) or server logs.
            </div>
          )}

          <div className="layout">
            <SideNav view={view} onChange={setView}/>
            <div className="panel">
              {view==='generator'  && <GeneratorView api={api}/>}
              {view==='batch'      && <BatchView api={api}/>}
              {view==='verify'     && <VerifyView api={api}/>}
              {view==='datasets'   && <DatasetsView api={api}/>}
              {view==='jobs'       && <JobsView api={api}/>}
              {view==='ml'         && <MLView api={api}/>}
              {view==='analytics'  && <AnalyticsView api={api}/>}
              {view==='settings'   && <Settings settings={settings} setSettings={setSettings}/>}
            </div>
          </div>
        </div>
      );
    }

    function SideNav({view,onChange}){
      const items = [
        ['generator','⚡','ODE Generator'],
        ['batch','📦','Batch Generation'],
        ['verify','✓','Verification'],
        ['datasets','💾','Datasets'],
        ['jobs','🧰','Jobs'],
        ['ml','🤖','ML'],
        ['analytics','📊','Analytics'],
        ['settings','⚙️','Settings']
      ];
      return (
        <div className="side">
          <div className="nav">
            {items.map(([id,icon,label])=>(
              <div key={id} className={'item '+(id===view?'active':'')} onClick={()=>onChange(id)}>
                <span>{icon}</span><span>{label}</span>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // ------- shared hook to load dropdown options -------
    function useOptions(api){
      const [gens,setGens]=useState([]), [funcs,setFuncs]=useState([]);
      const [loading,setLoading]=useState(true), [err,setErr]=useState(null);
      const load = useCallback(async ()=>{
        setLoading(true); setErr(null);
        try{
          const [g,f] = await Promise.all([api.generators(), api.functions()]);
          setGens(g?.all || []); setFuncs(f?.functions || []);
        }catch(e){
          setErr(e.debug ? JSON.stringify(e.debug) : (e?.response?.data?.detail || e.message));
        }finally{ setLoading(false); }
      }, [api]);
      useEffect(()=>{ load(); }, [load]);
      return {gens,funcs,loading,err, reload:load};
    }

    function GeneratorView({api}){
      const {gens,funcs,loading,err,reload} = useOptions(api);
      const [form,setForm]=useState({generator:'', function:'', count:1, verify:true, parameters:{}});
      const [busy,setBusy]=useState(false), [res,setRes]=useState(null), [e,setE]=useState(null);

      useEffect(()=>{ if(gens[0] && !form.generator) setForm(f=>({...f,generator:gens[0]})); },[gens]);
      useEffect(()=>{ if(funcs[0] && !form.function)  setForm(f=>({...f,function:funcs[0]})); },[funcs]);

      const go = async()=>{
        setBusy(true); setE(null); setRes(null);
        try{
          const r = await api.generate(form);
          if (r?.job_id){
            let done=false;
            while(!done){
              await sleep(700);
              const st = await api.job(r.job_id);
              if(st.status==='completed'){ setRes(st.results); done=true; }
              if(st.status==='failed'){ throw new Error(st.error || 'Job failed'); }
            }
          }else{ setRes(r); }
        }catch(ex){ setE(ex?.response?.data?.detail || ex.message); }
        finally{ setBusy(false); }
      };

      return (
        <>
          <h2 style={{marginBottom:8}}>ODE Generator</h2>
          {loading && <div className="muted">Loading options…</div>}
          {err && (
            <div className="error" style={{marginBottom:10}}>
              Failed to load generators/functions.<br/>
              <small className="muted">Details: {String(err)}</small><br/>
              <button className="btn ghost" style={{marginTop:8}} onClick={reload}>↻ Reload options</button>
            </div>
          )}

          <div className="grid" style={{marginTop:10}}>
            <div className="group">
              <label className="label">Generator</label>
              <select className="select" value={form.generator} disabled={!gens.length}
                      onChange={e=>setForm({...form, generator:e.target.value})}>
                {gens.map(g=><option key={g} value={g}>{g}</option>)}
              </select>
            </div>
            <div className="group">
              <label className="label">Function</label>
              <select className="select" value={form.function} disabled={!funcs.length}
                      onChange={e=>setForm({...form, function:e.target.value})}>
                {funcs.map(f=><option key={f} value={f}>{f}</option>)}
              </select>
            </div>
            <div className="group">
              <label className="label">Count</label>
              <input className="input" type="number" min="1" max="100" value={form.count}
                     onChange={e=>setForm({...form, count:parseInt(e.target.value||'1',10)})}/>
            </div>
            <div className="group">
              <label className="label">Verify</label>
              <select className="select" value={String(form.verify)} onChange={e=>setForm({...form, verify:(e.target.value==='true')})}>
                <option value="true">Yes</option><option value="false">No</option>
              </select>
            </div>
          </div>

          <div style={{marginTop:12, display:'flex', gap:10}}>
            <button className="btn primary" disabled={busy || !form.generator || !form.function} onClick={go}>
              {busy ? 'Generating…' : '⚡ Generate'}
            </button>
            <button className="btn ghost" onClick={reload}>↻ Reload options</button>
          </div>

          {e && <div className="error" style={{marginTop:12}}>{e}</div>}
          {res && <Results results={res}/>}
        </>
      );
    }

    function BatchView({api}){
      const {gens,funcs,err,reload} = useOptions(api);
      const [form,setForm]=useState({generators:[], functions:[], samples_per_combination:5, verify:true, save_dataset:true, dataset_name:''});
      const [busy,setBusy]=useState(false), [msg,setMsg]=useState(null), [e,setE]=useState(null);
      const toggle=(arr,v)=> arr.includes(v)? arr.filter(x=>x!==v):[...arr,v];
      const go = async()=>{
        setBusy(true); setE(null); setMsg(null);
        try{ const r = await api.batch(form); setMsg(`Job ${r.job_id} created. Expected ODEs: ${r.total_expected}`); }
        catch(ex){ setE(ex?.response?.data?.detail || ex.message); }
        finally{ setBusy(false); }
      };
      return (
        <>
          <h2 style={{marginBottom:8}}>Batch Generation</h2>
          {err && <div className="error" style={{marginBottom:10}}>Failed to load options. <button className="btn ghost" onClick={reload}>Reload</button></div>}
          <div className="group">
            <label className="label">Generators</label>
            <div style={{display:'flex',flexWrap:'wrap',gap:8}}>
              {gens.map(g=>(
                <label key={g} style={{display:'flex',gap:6,alignItems:'center'}}>
                  <input type="checkbox" checked={form.generators.includes(g)} onChange={()=>setForm({...form, generators:toggle(form.generators,g)})}/>
                  {g}
                </label>
              ))}
            </div>
          </div>
          <div className="group" style={{marginTop:10}}>
            <label className="label">Functions</label>
            <div style={{display:'flex',flexWrap:'wrap',gap:8}}>
              {funcs.map(f=>(
                <label key={f} style={{display:'flex',gap:6,alignItems:'center'}}>
                  <input type="checkbox" checked={form.functions.includes(f)} onChange={()=>setForm({...form, functions:toggle(form.functions,f)})}/>
                  {f}
                </label>
              ))}
            </div>
          </div>
          <div className="grid" style={{marginTop:10}}>
            <div className="group"><label className="label">Samples per Combination</label><input className="input" type="number" min="1" max="50" value={form.samples_per_combination} onChange={e=>setForm({...form, samples_per_combination:+e.target.value})}/></div>
            <div className="group"><label className="label">Save as Dataset</label><select className="select" value={String(form.save_dataset)} onChange={e=>setForm({...form, save_dataset:(e.target.value==='true')})}><option value="true">Yes</option><option value="false">No</option></select></div>
            <div className="group"><label className="label">Dataset Name (optional)</label><input className="input" value={form.dataset_name} onChange={e=>setForm({...form, dataset_name:e.target.value})} placeholder="auto if empty"/></div>
          </div>
          <div style={{marginTop:12}}>
            <button className="btn primary" disabled={busy || !form.generators.length || !form.functions.length} onClick={go}>{busy?'Submitting…':'Start Batch'}</button>
          </div>
          {e && <div className="error" style={{marginTop:12}}>{e}</div>}
          {msg && <div className="success" style={{marginTop:12}}>{msg}</div>}
        </>
      );
    }

    function VerifyView({api}){
      const [form,setForm]=useState({ode:'', solution:'', method:'substitution'});
      const [res,setRes]=useState(null), [busy,setBusy]=useState(false), [e,setE]=useState(null);
      const go=async()=>{
        setBusy(true); setE(null); setRes(null);
        try{ const r = await api.verify(form); setRes(r); }catch(ex){ setE(ex?.response?.data?.detail || ex.message); }finally{ setBusy(false); }
      };
      return (
        <>
          <h2 style={{marginBottom:8}}>Verification</h2>
          <div className="group"><label className="label">ODE (Sympy Eq(...))</label><textarea className="input" rows="3" placeholder="Eq(Derivative(y(x),x,2) + y(x), sin(x))" value={form.ode} onChange={e=>setForm({...form, ode:e.target.value})}/></div>
          <div className="group" style={{marginTop:10}}><label className="label">Solution</label><textarea className="input" rows="3" placeholder="sin(x) + cos(x)" value={form.solution} onChange={e=>setForm({...form, solution:e.target.value})}/></div>
          <div className="group" style={{marginTop:10}}><label className="label">Method</label><select className="select" value={form.method} onChange={e=>setForm({...form, method:e.target.value})}><option value="substitution">substitution</option><option value="numeric">numeric</option></select></div>
          <div style={{marginTop:12}}><button className="btn primary" disabled={busy || !form.ode || !form.solution} onClick={go}>{busy?'Verifying…':'Verify'}</button></div>
          {e && <div className="error" style={{marginTop:12}}>{e}</div>}
          {res && <div className={res.verified?'success':'error'} style={{marginTop:12}}><b>Verified:</b> {String(res.verified)} • <b>Method:</b> {res.method} • <b>Confidence:</b> {(res.confidence*100).toFixed(1)}% {res.error && <div>({res.error})</div>}</div>}
        </>
      );
    }

    function DatasetsView({api}){
      const [items,setItems]=useState([]), [loading,setLoading]=useState(true), [e,setE]=useState(null);
      const load=useCallback(async()=>{ setLoading(true); setE(null); try{ const r=await api.datasets(); setItems(r.datasets||[]);}catch(ex){ setE(ex?.response?.data?.detail||ex.message);}finally{setLoading(false);} },[api]);
      useEffect(()=>{ load(); },[load]);
      const dl=async(name,fmt)=>{ try{ const blob=await api.downloadDataset(name,fmt); downloadBlob(blob,`${name}.${fmt}`);}catch(ex){ alert('Download failed: '+(ex?.response?.data?.detail||ex.message)); } };
      return (
        <>
          <h2 style={{marginBottom:8}}>Datasets</h2>
          <div style={{marginBottom:8}}><button className="btn ghost" onClick={load}>↻ Refresh</button></div>
          {loading && <div className="muted">Loading…</div>}
          {e && <div className="error">{e}</div>}
          {!loading && !e && (
            <div className="jobs">
              {items.map(d=>(
                <div className="job" key={d.name}>
                  <div><div style={{fontWeight:700}}>{d.name}</div><div className="muted">Size: {(d.size_bytes/1024).toFixed(2)} KB • Created: {new Date(d.created_at).toLocaleString()}</div></div>
                  <div style={{display:'flex',gap:8}}><button className="btn ghost" onClick={()=>dl(d.name,'jsonl')}>JSONL</button><button className="btn ghost" onClick={()=>dl(d.name,'csv')}>CSV</button></div>
                </div>
              ))}
              {items.length===0 && <div className="muted">No datasets yet.</div>}
            </div>
          )}
        </>
      );
    }

    function JobsView({api}){
      const [tab,setTab]=useState('all'), [rows,setRows]=useState([]), [tick,setTick]=useState(0);
      const load=useCallback(async()=>{ try{ const r=await api.jobs(tab==='all'?null:tab); setRows(r.jobs||[]);}catch{} },[api,tab]);
      useEffect(()=>{ load(); const t=setInterval(()=>setTick(x=>x+1),1500); return ()=>clearInterval(t); },[load]);
      useEffect(()=>{ load(); },[tick]);
      const cancel=async(id)=>{ if(!confirm('Cancel job?')) return; try{ await api.cancel(id); load(); }catch{ alert('Cancel failed'); } };
      const tabs=['all','queued','running','completed','failed'];
      return (
        <>
          <h2 style={{marginBottom:8}}>Jobs</h2>
          <div className="tabs">{tabs.map(t=><button key={t} className={'tab '+(tab===t?'active':'')} onClick={()=>setTab(t)}>{t[0].toUpperCase()+t.slice(1)}</button>)}</div>
          <div className="jobs">
            {rows.map(j=>(
              <div key={j.job_id} className="job">
                <div><div style={{fontWeight:700}}>{j.job_id}</div><div className="muted">Status: {j.status} • Progress: {j.progress?.toFixed?.(0)??0}%</div></div>
                <div style={{display:'flex',alignItems:'center',gap:12}}>
                  <div className="bar"><div className="fill" style={{width:`${Math.max(0,Math.min(100,j.progress||0))}%`}}></div></div>
                  {(j.status==='queued'||j.status==='running') && <button className="btn ghost" onClick={()=>cancel(j.job_id)}>Cancel</button>}
                </div>
              </div>
            ))}
            {rows.length===0 && <div className="muted">No jobs.</div>}
          </div>
        </>
      );
    }

    function MLView({api}){
      const [tab,setTab]=useState('models'), [models,setModels]=useState([]), [datasets,setDatasets]=useState([]);
      const [train,setTrain]=useState({dataset:'', model_type:'pattern_net', epochs:10, batch_size:32, learning_rate:0.001, early_stopping:true, validation_split:0.2});
      const [gen,setGen]=useState({model_path:'', n_samples:10, temperature:0.8});
      const [msg,setMsg]=useState(null), [e,setE]=useState(null);

      const load=useCallback(async()=>{
        try{
          const [m,d] = await Promise.all([api.models(), api.datasets()]);
          setModels(m.models||[]); setDatasets(d.datasets||[]);
          if(!train.dataset && d.datasets?.[0]) setTrain(s=>({...s,dataset:d.datasets[0].name}));
          if(!gen.model_path && m.models?.[0]) setGen(s=>({...s, model_path:(m.models[0].name+'.pth')})); // may vary by your backend
        }catch{}
      },[api]);
      useEffect(()=>{ load(); },[load]);

      const startTrain=async()=>{ setE(null); setMsg(null); try{ const r=await api.mlTrain(train); setMsg(`Training job ${r.job_id} created.`);}catch(ex){ setE(ex?.response?.data?.detail||ex.message);} };
      const startGen=async()=>{ setE(null); setMsg(null); try{ const r=await api.mlGen(gen); setMsg(`Generation job ${r.job_id} created.`);}catch(ex){ setE(ex?.response?.data?.detail||ex.message);} };

      return (
        <>
          <h2 style={{marginBottom:8}}>ML Pipeline</h2>
          <div className="tabs">{['models','train','generate'].map(t=><button key={t} className={'tab '+(tab===t?'active':'')} onClick={()=>setTab(t)}>{t[0].toUpperCase()+t.slice(1)}</button>)}</div>
          {tab==='models' && (
            <div className="jobs">
              {models.map(m=>(
                <div className="job" key={m.name}>
                  <div><div style={{fontWeight:700}}>{m.name}</div><div className="muted">Size: {(m.size_bytes/(1024*1024)).toFixed(2)} MB • {new Date(m.created_at).toLocaleString()}</div></div>
                </div>
              ))}
              {models.length===0 && <div className="muted">No models found.</div>}
            </div>
          )}
          {tab==='train' && (
            <>
              <div className="grid">
                <div className="group"><label className="label">Dataset</label><select className="select" value={train.dataset} onChange={e=>setTrain({...train, dataset:e.target.value})}>{datasets.map(d=><option key={d.name} value={d.name}>{d.name}</option>)}</select></div>
                <div className="group"><label className="label">Model Type</label><select className="select" value={train.model_type} onChange={e=>setTrain({...train, model_type:e.target.value})}><option value="pattern_net">pattern_net</option><option value="transformer">transformer</option><option value="vae">vae</option></select></div>
                <div className="group"><label className="label">Epochs</label><input className="input" type="number" min="1" max="1000" value={train.epochs} onChange={e=>setTrain({...train,epochs:+e.target.value})}/></div>
                <div className="group"><label className="label">Batch Size</label><input className="input" type="number" min="8" max="256" value={train.batch_size} onChange={e=>setTrain({...train,batch_size:+e.target.value})}/></div>
                <div className="group"><label className="label">Learning Rate</label><input className="input" type="number" step="0.0001" value={train.learning_rate} onChange={e=>setTrain({...train,learning_rate:+e.target.value})}/></div>
                <div className="group"><label className="label">Early Stopping</label><select className="select" value={String(train.early_stopping)} onChange={e=>setTrain({...train, early_stopping:(e.target.value==='true')})}><option value="true">true</option><option value="false">false</option></select></div>
                <div className="group"><label className="label">Validation Split</label><input className="input" type="number" min="0.1" max="0.5" step="0.05" value={train.validation_split} onChange={e=>setTrain({...train, validation_split:+e.target.value})}/></div>
              </div>
              <div style={{marginTop:12}}><button className="btn primary" onClick={startTrain}>Start Training</button></div>
            </>
          )}
          {tab==='generate' && (
            <>
              <div className="grid">
                <div className="group"><label className="label">Model path</label><input className="input" value={gen.model_path} onChange={e=>setGen({...gen, model_path:e.target.value})}/></div>
                <div className="group"><label className="label">Samples</label><input className="input" type="number" min="1" max="1000" value={gen.n_samples} onChange={e=>setGen({...gen, n_samples:+e.target.value})}/></div>
                <div className="group"><label className="label">Temperature</label><input className="input" type="number" min="0.1" max="2" step="0.1" value={gen.temperature} onChange={e=>setGen({...gen, temperature:+e.target.value})}/></div>
              </div>
              <div style={{marginTop:12}}><button className="btn primary" onClick={startGen}>Start ML Generation</button></div>
            </>
          )}
          {e && <div className="error" style={{marginTop:12}}>{e}</div>}
          {msg && <div className="success" style={{marginTop:12}}>{msg}</div>}
        </>
      );
    }

    function AnalyticsView({api}){
      const [stats,setStats]=useState(null); const canvasRef=useRef(null); const chartRef=useRef(null);
      const load=useCallback(async()=>{ try{ setStats(await api.stats()); }catch{} },[api]);
      useEffect(()=>{ load(); const t=setInterval(load,5000); return()=>clearInterval(t); },[load]);
      useEffect(()=>{ if(!canvasRef.current || !stats) return; chartRef.current && chartRef.current.destroy(); chartRef.current = new Chart(canvasRef.current.getContext('2d'), {type:'bar', data:{labels:Object.keys(stats.queue_stats||{}), datasets:[{label:'Queued Jobs', data:Object.values(stats.queue_stats||{}), borderWidth:1}]}, options:{responsive:true, scales:{y:{beginAtZero:true}}}}); },[stats]);
      return (
        <>
          <h2 style={{marginBottom:8}}>Analytics</h2>
          {!stats && <div className="muted">Loading…</div>}
          {stats && (
            <>
              <div className="grid" style={{marginBottom:10}}>
                <Stat title="Generated (24h)" value={stats.statistics?.total_generated_24h ?? 0}/>
                <Stat title="Verification Rate" value={`${((stats.statistics?.verification_rate||0)*100).toFixed(1)}%`}/>
                <Stat title="Active Jobs" value={stats.statistics?.active_jobs ?? 0}/>
                <Stat title="Total Jobs" value={stats.statistics?.total_jobs ?? 0}/>
              </div>
              <div className="card"><h3 style={{margin:'0 0 10px'}}>Queues</h3><div style={{height:300}}><canvas ref={canvasRef}/></div></div>
              <div className="card"><h3 style={{margin:'0 0 8px'}}>Capabilities</h3><div className="muted">Generators: {stats.capabilities?.generators ?? 0} • Functions: {stats.capabilities?.functions ?? 0} • ML: {stats.capabilities?.ml_enabled?'on':'off'} • Redis: {stats.capabilities?.redis_enabled?'on':'off'}</div></div>
            </>
          )}
        </>
      );
    }
    function Stat({title,value}){ return (<div className="card"><div style={{fontSize:26,fontWeight:800,color:'var(--primary)'}}>{value}</div><div className="muted">{title}</div></div>); }

    function Results({results}){
      const arr = Array.isArray(results)?results:[results];
      useEffect(()=>{ window.MathJax?.typesetPromise?.(); },[results]);
      return (
        <div className="results">
          <h3 style={{marginTop:0}}>Results</h3>
          {arr.map((r,i)=>(
            <div key={i} className="card">
              <div className="row"><div style={{fontWeight:700}}>{r.generator} • {r.function}</div><span className={'badge '+(r.verified?'ok':'bad')}>{r.verified?'Verified':'Not Verified'}</span></div>
              <div style={{marginTop:8}}><div className="muted">ODE</div><div className="code">{String(r.ode||'')}</div></div>
              <div style={{marginTop:8}}><div className="muted">Solution</div><div className="code">{String(r.solution||'')}</div></div>
              {r.verification && <div style={{marginTop:8}} className="muted">Method: {r.verification.method} • Confidence: {(r.verification.confidence*100).toFixed(1)}%</div>}
            </div>
          ))}
          {arr.length===0 && <div className="muted">No items.</div>}
        </div>
      );
    }

    function Settings({settings,setSettings}){
      const [form,setForm]=useState(settings);
      const save=()=>{
        localStorage.setItem('ode_gui_settings', JSON.stringify(form));
        setSettings(form);
        alert('Saved. Reloading…');
        setTimeout(()=>location.reload(), 150);
      };
      return (
        <>
          <h2 style={{marginBottom:8}}>Settings</h2>
          <div className="grid">
            <div className="group"><label className="label">API Base</label><input className="input" value={form.API_BASE} onChange={e=>setForm({...form, API_BASE:e.target.value})}/></div>
            <div className="group"><label className="label">API Key (X-API-Key)</label><input className="input" value={form.API_KEY} onChange={e=>setForm({...form, API_KEY:e.target.value})}/></div>
            <div className="group"><label className="label">WebSocket</label><select className="select" value={String(form.WS)} onChange={e=>setForm({...form, WS:(e.target.value==='true')})}><option value="true">true</option><option value="false">false</option></select></div>
          </div>
          <div style={{marginTop:12,display:'flex',gap:10}}>
            <button className="btn primary" onClick={save}>Save</button>
            <button className="btn ghost" onClick={()=>{localStorage.removeItem('ode_gui_settings'); alert('Cleared saved settings. Reloading…'); location.reload();}}>Reset</button>
          </div>
        </>
      );
    }

    // mount
    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
