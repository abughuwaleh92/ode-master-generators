<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ODE Master Generators â€“ Control Panel</title>

  <!-- React / Axios / Chart.js / MathJax (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.7/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script defer src="/config.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --ok: #10b981;
      --warn: #f59e0b;
      --err: #ef4444;
      --ink: #0f172a;
      --fg: #111827;
      --muted: #6b7280;
      --bg: #f8fafc;
      --panel: #ffffff;
      --light: #f3f4f6;
      --border: #e5e7eb;
      --shadow: 0 10px 25px rgba(0,0,0,.06);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) fixed;
      font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,system-ui,Arial,sans-serif;
      color: var(--fg);
    }
    .shell { max-width: 1400px; margin: 20px auto; padding: 0 20px 40px; }
    .top {
      background: var(--panel); border-radius: 12px; padding: 16px 20px; box-shadow: var(--shadow);
      display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 16px;
    }
    .brand { display:flex; align-items:center; gap: 12px; font-weight: 800; color: #3b3b9e; font-size: 22px; }
    .muted { color: var(--muted); font-weight: 600; }
    .badges { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .badge { padding:8px 12px; border-radius: 999px; background:#eef2ff; color:#3730a3; font-weight:600; }
    .badge.ok { background:#ecfdf5; color:#065f46; }
    .badge.err { background:#fef2f2; color:#991b1b; }
    .badge.warn{ background:#fffbeb; color:#92400e; }
    .btn {
      background: var(--primary); color: white; border:none; border-radius: 10px; padding: 10px 14px;
      font-weight: 700; cursor: pointer;
    }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .layout { display:grid; grid-template-columns: 260px 1fr; gap: 18px; }
    .side {
      background: var(--panel); border-radius: 12px; box-shadow: var(--shadow); padding: 10px;
      position: sticky; top: 20px; height: fit-content;
    }
    .nav-btn {
      width:100%; text-align:left; padding: 14px 14px; border:none; background:transparent;
      border-radius:10px; font-weight:700; display:flex; gap:10px; align-items:center; cursor:pointer;
    }
    .nav-btn.active, .nav-btn:hover { background: var(--light); }
    .panel {
      background: var(--panel); border-radius: 12px; box-shadow: var(--shadow); padding: 22px; min-height: 560px;
    }
    h2 { margin: 10px 0 18px; font-size: 28px; }
    .row { display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px; }
    .field { grid-column: span 4; display:flex; flex-direction:column; gap:6px; }
    label { font-weight: 700; }
    select, input[type="number"], input[type="text"], textarea {
      border:1px solid var(--border); border-radius: 10px; padding: 10px 12px; font-size: 14px; background:white;
    }
    .help { color: var(--muted); font-size: 13px; }
    .alert {
      background:#fef2f2; color:#991b1b; border:1px solid #fecaca; padding:12px 14px; border-radius:10px;
      margin-bottom: 12px; font-weight:600;
    }
    .alert.ok { background:#ecfdf5; border-color:#a7f3d0; color:#065f46; }
    .grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); }
    .card { border:1px solid var(--border); border-radius:10px; padding:12px; background:white; }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }
    .spacer { height: 8px; }
  </style>
</head>
<body>
  <div id="app"></div>

<script>
(function () {
  const e = React.createElement;
  const {useEffect, useMemo, useState, useRef} = React;

  // ---------- Utilities ----------
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  const loadWinConfig = ()=> (typeof window.ODE_CONFIG === 'object' ? window.ODE_CONFIG : null);
  const loadSaved = ()=>{
    try { return JSON.parse(localStorage.getItem('ode.gui.cfg')||'{}'); } catch { return {}; }
  };
  const saveCfg = (cfg)=> localStorage.setItem('ode.gui.cfg', JSON.stringify(cfg));

  function joinUrl(base, path) {
    if (!path) return base;
    return (base.replace(/\/+$/,'') + '/' + path.replace(/^\/+/, ''));
  }

  // ---------- API Client ----------
  class APIClient {
    constructor(base, key, timeoutMs=60000) {
      this.base = base;
      this.key = key || '';
      this.timeout = timeoutMs;
      this.prefix = '/api'; // default; will be confirmed by detectPrefix()
      this.anon = axios.create({ baseURL: base, timeout: timeoutMs });
      this.auth = axios.create({
        baseURL: base, timeout: timeoutMs,
        headers: key ? {'X-API-Key': key} : {}
      });
    }
    setConfig({base, key}) {
      this.base = base ?? this.base;
      this.key = key ?? this.key;
      this.anon = axios.create({ baseURL: this.base, timeout: this.timeout });
      this.auth = axios.create({
        baseURL: this.base, timeout: this.timeout,
        headers: this.key ? {'X-API-Key': this.key} : {}
      });
    }
    async health() {
      const r = await this.anon.get('/health', {validateStatus:()=>true});
      return r;
    }
    // Robust prefix detection:
    //  - try /api/info (no key required in your server)
    //  - then /api/generators with KEY
    //  - accept 200 or 403 as "prefix is correct" (403 just means key missing/wrong)
    //  - fallback to /api/v1 if /api is truly not found (404)
    async detectPrefix() {
      const tryPaths = ['/api/info','/api/generators'];
      for (const p of tryPaths) {
        // choose client: use auth when we may need key
        const client = p.includes('generators') ? this.auth : this.anon;
        try {
          const r = await client.get(p, { validateStatus:()=>true });
          if (r.status === 200) { this.prefix = p.startsWith('/api') ? '/api' : '/'; return {prefix:this.prefix, status:r.status}; }
          if (r.status === 403) { this.prefix = '/api'; return {prefix:this.prefix, status:r.status}; } // key required -> prefix is fine
          if (r.status === 404) continue;
        } catch { /* continue */ }
      }
      // try /api/v1 (legacy)
      try {
        const r = await this.auth.get('/api/v1/generators', {validateStatus:()=>true});
        if (r.status === 200 || r.status === 403) { this.prefix = '/api/v1'; return {prefix:this.prefix, status:r.status}; }
      } catch {}
      throw new Error('Could not detect API prefix');
    }

    // Endpoints (use detected prefix)
    async getGenerators() {
      const r = await this.auth.get(joinUrl(this.prefix,'/generators'));
      return r.data;
    }
    async getFunctions() {
      const r = await this.auth.get(joinUrl(this.prefix,'/functions'));
      return r.data;
    }
    async generate(payload) {
      const r = await this.auth.post(joinUrl(this.prefix,'/generate'), payload);
      return r.data;
    }
    async batchGenerate(payload) {
      const r = await this.auth.post(joinUrl(this.prefix,'/batch_generate'), payload);
      return r.data;
    }
    async job(jobId) {
      const r = await this.auth.get(joinUrl(this.prefix, `/jobs/${jobId}`));
      return r.data;
    }
    async jobs(qs={}) {
      const r = await this.auth.get(joinUrl(this.prefix,'/jobs'), { params: qs });
      return r.data;
    }
    async datasets() {
      const r = await this.auth.get(joinUrl(this.prefix,'/datasets'));
      return r.data;
    }
    async stats() {
      const r = await this.auth.get(joinUrl(this.prefix,'/stats'));
      return r.data;
    }
  }

  // ---------- App ----------
  function App() {
    // config
    const startCfg = (()=> {
      const win = loadWinConfig() || {};
      const saved = loadSaved();
      const base = saved.API_BASE || win.API_BASE || window.location.origin;
      const key  = saved.API_KEY  || win.API_KEY  || '';
      const ws   = (saved.WS ?? (typeof win.WS==='boolean'?win.WS:true));
      return {API_BASE: base, API_KEY: key, WS: Boolean(ws)};
    })();

    const [cfg, setCfg] = useState(startCfg);
    const [client] = useState(()=> new APIClient(startCfg.API_BASE, startCfg.API_KEY));
    const [view, setView] = useState('gen'); // gen|batch|verify|datasets|jobs|ml|analytics|settings
    const [apiOk, setApiOk] = useState(null); // null|true|false
    const [mlOk, setMlOk] = useState(null);
    const [cacheOk, setCacheOk] = useState(null);
    const [wsOk, setWsOk] = useState(null);
    const [prefix, setPrefix] = useState(null);
    const [alert, setAlert] = useState('');

    // on mount / on cfg change
    useEffect(()=> {
      (async ()=>{
        setAlert('');
        client.setConfig({base: cfg.API_BASE, key: cfg.API_KEY});
        try {
          // 1) health
          const hr = await client.health();
          setApiOk(hr.status===200 && (typeof hr.data==='object' || hr.data==='ok'));
          if (hr.status===200 && typeof hr.data==='object') {
            setMlOk(Boolean(hr.data?.services?.ml_pipeline));
            setCacheOk(Boolean(hr.data?.services?.cache));
          } else { setMlOk(null); setCacheOk(null); }

          // 2) detect prefix (robust to 403)
          const pr = await client.detectPrefix();
          setPrefix(pr.prefix);

        } catch (err) {
          setApiOk(false);
          setAlert('API is not reachable. Check API Base and that your server is running.');
          return;
        }
      })();
    }, [cfg.API_BASE, cfg.API_KEY]);

    // WebSocket badge (optional)
    useEffect(()=>{
      if (!cfg.WS) return setWsOk(null);
      let ws;
      try {
        const wsUrl = cfg.API_BASE.replace('http','ws') + '/ws/gui-' + Date.now();
        ws = new WebSocket(wsUrl);
        ws.onopen = ()=> setWsOk(true);
        ws.onclose = ()=> setWsOk(false);
        ws.onerror = ()=> setWsOk(false);
      } catch { setWsOk(false); }
      return ()=> ws && ws.close();
    }, [cfg.API_BASE, cfg.WS]);

    const onSaveCfg = (next)=>{
      const merged = {...cfg, ...next};
      setCfg(merged);
      saveCfg(merged);
    };

    return e('div', {className:'shell'},
      e('div', {className:'top'},
        e('div', {className:'brand'}, 'ðŸ”¬ ODE Master Generators', e('span',{className:'muted', style:{marginLeft:8}}, 'Control Panel')),
        e('div', {className:'badges'},
          e('span', {className:`badge ${apiOk? 'ok': apiOk===false?'err':'warn'}`}, `API: ${apiOk===null?'checkingâ€¦': apiOk? 'ok':'bad'}`),
          e('span', {className:`badge ${mlOk===null?'warn': (mlOk?'ok':'err')}`}, `ML: ${mlOk===null?'?': (mlOk?'âœ“':'X')}`),
          e('span', {className:`badge ${cacheOk===null?'warn': (cacheOk?'ok':'err')}`}, `Cache: ${cacheOk===null?'?': (cacheOk?'âœ“':'X')}`),
          e('span', {className:`badge ${wsOk===null?'warn': (wsOk?'ok':'err')}`}, `WS: ${wsOk===null?'?': (wsOk?'âœ“':'X')}`),
          e('button', {className:'btn', onClick: ()=> setCfg({...cfg})}, 'â†» Refresh')
        )
      ),

      e('div', {className:'layout'},
        e('div', {className:'side'},
          NavButton({id:'gen', label:'ODE Generator', icon:'âš¡', view, setView}),
          NavButton({id:'batch', label:'Batch Generation', icon:'ðŸ“¦', view, setView}),
          NavButton({id:'verify', label:'Verification', icon:'âœ“', view, setView}),
          NavButton({id:'datasets', label:'Datasets', icon:'ðŸ’¾', view, setView}),
          NavButton({id:'jobs', label:'Jobs', icon:'ðŸ› ï¸', view, setView}),
          NavButton({id:'ml', label:'ML', icon:'ðŸ¤–', view, setView}),
          NavButton({id:'analytics', label:'Analytics', icon:'ðŸ“Š', view, setView}),
          NavButton({id:'settings', label:'Settings', icon:'âš™ï¸', view, setView}),
        ),
        e('div', {className:'panel'},
          alert ? e('div',{className:'alert'}, alert) : null,

          view==='settings' ? e(SettingsView, {cfg, onSave:onSaveCfg}) : null,
          view==='gen'      ? e(GeneratorView, {client, apiOk, prefix}) : null,
          view==='batch'    ? e(BatchView, {client, apiOk, prefix}) : null,
          view==='datasets' ? e(DatasetsView, {client, apiOk, prefix}) : null,
          view==='jobs'     ? e(JobsView, {client, apiOk, prefix}) : null,
          view==='verify'   ? e(VerifyView, {client, apiOk, prefix}) : null,
          view==='analytics'? e(AnalyticsView, {client, apiOk, prefix}) : null,
          view==='ml'       ? e(MLView, {client, apiOk, prefix}) : null
        )
      )
    );
  }

  function NavButton({id,label,icon,view,setView}) {
    return e('button',{
      className: 'nav-btn ' + (view===id? 'active':''), onClick: ()=> setView(id)
    }, e('span',null,icon), label);
  }

  // ---------- Settings ----------
  function SettingsView({cfg, onSave}) {
    const [base,setBase] = useState(cfg.API_BASE);
    const [key,setKey]   = useState(cfg.API_KEY);
    const [ws,setWs]     = useState(cfg.WS);
    return e(React.Fragment, {},
      e('h2', null, 'Settings'),
      e('div',{className:'row'},
        e('div',{className:'field', style:{gridColumn:'span 6'}},
          e('label', null, 'API Base'),
          e('input', {value:base, onChange:e=>setBase(e.target.value), placeholder:'https://ode-api.up.railway.app'})
        ),
        e('div',{className:'field', style:{gridColumn:'span 6'}},
          e('label', null, 'API Key (X-API-Key)'),
          e('input', {value:key, onChange:e=>setKey(e.target.value), placeholder:'dev-key'})
        ),
        e('div',{className:'field', style:{gridColumn:'span 3'}},
          e('label', null, 'WebSocket'),
          e('select', {value:String(ws), onChange:e=>setWs(e.target.value==='true')},
            e('option',{value:'true'}, 'true'), e('option',{value:'false'}, 'false')
          )
        )
      ),
      e('div',{className:'spacer'}),
      e('button',{className:'btn', onClick:()=> onSave({API_BASE:base, API_KEY:key, WS:ws})}, 'Save'),
      e('span',{className:'help', style:{marginLeft:12}}, 'Saved to localStorage.')
    );
  }

  // ---------- Generator ----------
  function GeneratorView({client, apiOk, prefix}) {
    const [gens,setGens] = useState([]);
    const [funcs,setFuncs] = useState([]);
    const [gen,setGen] = useState('');
    const [fun,setFun] = useState('');
    const [count,setCount] = useState(1);
    const [verify,setVerify] = useState(true);
    const [loading,setLoading] = useState(false);
    const [err,setErr] = useState('');
    const [job,setJob] = useState(null);
    const [results,setResults] = useState(null);

    useEffect(()=>{
      let cancelled = false;
      (async ()=>{
        setErr(''); setResults(null);
        if (!apiOk || !prefix) return;
        try {
          const [g,f] = await Promise.all([client.getGenerators(), client.getFunctions()]);
          if (cancelled) return;
          const allG = g?.all || [];
          const allF = f?.functions || [];
          setGens(allG); setFuncs(allF);
          if (!gen && allG.length) setGen(allG[0]);
          if (!fun && allF.length) setFun(allF[0]);
        } catch (e) {
          setErr('Failed to load options. Check API key and CORS.');
        }
      })();
      return ()=> {cancelled = true;}
    }, [apiOk, prefix]);

    async function run() {
      setErr(''); setLoading(true); setResults(null);
      try {
        const resp = await client.generate({generator: gen, function: fun, count, verify});
        if (resp?.job_id) {
          setJob(resp.job_id);
          // poll
          for (let i=0; i<600; i++) { // up to 5 min
            await sleep(1000);
            const s = await client.job(resp.job_id);
            if (s.status==='completed') { setResults(s.results); break; }
            if (s.status==='failed' || s.status==='cancelled') { setErr(`Job ${s.status}: `+(s.error||'')); break; }
          }
        } else {
          setResults(resp);
        }
      } catch (e) {
        setErr(e?.response?.data?.detail || e.message || 'Generation failed');
      } finally { setLoading(false); }
    }

    return e(React.Fragment, {},
      e('h2', null, 'ODE Generator'),
      err ? e('div',{className:'alert'}, err) : null,
      e('div',{className:'row'},
        e('div',{className:'field', style:{gridColumn:'span 5'}},
          e('label', null, 'Generator'),
          e('select',{value:gen, onChange:e=>setGen(e.target.value), disabled:!gens.length},
            gens.length? null : e('option',null,'Loadingâ€¦'),
            gens.map(x=> e('option',{key:x, value:x}, x))
          )
        ),
        e('div',{className:'field', style:{gridColumn:'span 5'}},
          e('label', null, 'Function'),
          e('select',{value:fun, onChange:e=>setFun(e.target.value), disabled:!funcs.length},
            funcs.length? null : e('option',null,'Loadingâ€¦'),
            funcs.map(x=> e('option',{key:x, value:x}, x))
          )
        ),
        e('div',{className:'field', style:{gridColumn:'span 2'}},
          e('label', null, 'Count'),
          e('input',{type:'number', min:1, max:100, value:count, onChange:e=>setCount(Number(e.target.value)||1)})
        )
      ),
      e('div',{className:'row'},
        e('div',{className:'field', style:{gridColumn:'span 3'}},
          e('label', null, 'Verify'),
          e('select',{value:String(verify), onChange:e=>setVerify(e.target.value==='true')},
            e('option',{value:'true'}, 'Yes'), e('option',{value:'false'}, 'No')
          )
        )
      ),
      e('button',{className:'btn', disabled:!(gen&&fun) || loading, onClick:run}, loading? 'Generatingâ€¦' : 'âš¡ Generate'),

      results ? e('div',{style:{marginTop:16}},
        e('h3',null,'Results'),
        Array.isArray(results) ? e('div',{className:'grid'},
          results.map((r,i)=> e(ResultCard,{key:i, r}))
        ) : e(ResultCard,{r:results})
      ) : null
    );
  }

  function ResultCard({r}) {
    useEffect(()=> { if (window.MathJax?.typesetPromise) window.MathJax.typesetPromise(); }, [r]);
    return e('div',{className:'card'},
      e('div',{style:{fontWeight:800, marginBottom:8}}, `${r.generator} â€“ ${r.function}`),
      e('div',null, e('div',{className:'mono'}, `ODE: ${r.ode}`)),
      r.solution? e('div',null, e('div',{className:'mono'}, `Solution: ${r.solution}`)) : null,
      r.verification? e('div',{className:'help', style:{marginTop:8}},
        `Verification: ${r.verification.method}, conf ${(r.verification.confidence*100).toFixed(1)}%`
      ) : null
    );
  }

  // ---------- Batch ----------
  function BatchView({client, apiOk, prefix}) {
    const [gens,setGens] = useState([]);
    const [funcs,setFuncs] = useState([]);
    const [selG,setSelG] = useState([]);
    const [selF,setSelF] = useState([]);
    const [n,setN] = useState(5);
    const [verify,setVerify] = useState(true);
    const [save,setSave] = useState(true);
    const [dsName,setDsName] = useState('');
    const [err,setErr] = useState('');
    const [msg,setMsg] = useState('');
    useEffect(()=>{
      let cancelled = false;
      (async ()=>{
        setErr('');
        if (!apiOk || !prefix) return;
        try {
          const [g,f] = await Promise.all([client.getGenerators(), client.getFunctions()]);
          if (cancelled) return;
          const allG = g?.all || [];
          const allF = f?.functions || [];
          setGens(allG); setFuncs(allF);
          setSelG(allG.slice(0,2)); setSelF(allF.slice(0,3));
        } catch { setErr('Failed to load options.'); }
      })();
      return ()=>{cancelled = true;}
    }, [apiOk, prefix]);
    async function run() {
      setErr(''); setMsg('');
      try {
        const r = await client.batchGenerate({
          generators: selG, functions: selF,
          samples_per_combination: n, verify, save_dataset: save,
          dataset_name: dsName || null
        });
        setMsg(`Job ${r.job_id} queued. Expected: ${r.total_expected}`);
      } catch (e) {
        setErr(e?.response?.data?.detail || e.message || 'Batch failed');
      }
    }
    return e(React.Fragment, {},
      e('h2', null, 'Batch Generation'),
      err ? e('div',{className:'alert'}, err) : null,
      msg ? e('div',{className:'alert ok'}, msg) : null,
      e('div',{className:'row'},
        e('div',{className:'field', style:{gridColumn:'span 12'}},
          e('label', null, 'Generators'),
          e('div', null,
            gens.map(g=> e('label',{key:g, style:{marginRight:8}},
              e('input',{type:'checkbox', checked: selG.includes(g),
                onChange: ev => setSelG(ev.target.checked ? [...new Set([...selG,g])] : selG.filter(x=>x!==g))
              }),
              ' ', g))
          ),
          e('div',{className:'help'}, 'Select at least one')
        ),
        e('div',{className:'field', style:{gridColumn:'span 12'}},
          e('label', null, 'Functions'),
          e('div', null,
            funcs.map(f=> e('label',{key:f, style:{marginRight:8}},
              e('input',{type:'checkbox', checked: selF.includes(f),
                onChange: ev => setSelF(ev.target.checked ? [...new Set([...selF,f])] : selF.filter(x=>x!==f))
              }),
              ' ', f))
          )
        ),
        e('div',{className:'field', style:{gridColumn:'span 2'}},
          e('label', null, 'Samples/combination'),
          e('input',{type:'number', min:1, max:50, value:n, onChange:e=>setN(Number(e.target.value)||1)})
        ),
        e('div',{className:'field', style:{gridColumn:'span 2'}},
          e('label', null, 'Verify'),
          e('select',{value:String(verify), onChange:e=>setVerify(e.target.value==='true')},
            e('option',{value:'true'}, 'Yes'), e('option',{value:'false'}, 'No')
          )
        ),
        e('div',{className:'field', style:{gridColumn:'span 2'}},
          e('label', null, 'Save dataset'),
          e('select',{value:String(save), onChange:e=>setSave(e.target.value==='true')},
            e('option',{value:'true'}, 'Yes'), e('option',{value:'false'}, 'No')
          )
        ),
        e('div',{className:'field', style:{gridColumn:'span 6'}},
          e('label', null, 'Dataset name (optional)'),
          e('input',{value:dsName, onChange:e=>setDsName(e.target.value)})
        )
      ),
      e('button',{className:'btn', disabled:!(selG.length && selF.length), onClick:run}, 'Start Batch')
    );
  }

  // ---------- Datasets ----------
  function DatasetsView({client, apiOk, prefix}) {
    const [list,setList] = useState(null);
    const [err,setErr] = useState('');
    useEffect(()=>{
      let cancelled=false;
      (async ()=>{
        setErr('');
        if (!apiOk || !prefix) return;
        try {
          const r = await client.datasets(); if (cancelled) return;
          setList(r?.datasets || []);
        } catch { setErr('Failed to load datasets'); }
      })();
      return ()=>{cancelled=true;}
    }, [apiOk, prefix]);
    return e(React.Fragment, {},
      e('h2', null, 'Datasets'),
      err ? e('div',{className:'alert'}, err) : null,
      !list ? e('div',null,'Loadingâ€¦') :
      list.length===0 ? e('div', {className:'help'}, 'No datasets found.') :
      e('div',{className:'grid'},
        list.map(d=> e('div',{className:'card', key:d.name},
          e('div', {style:{fontWeight:800}}, d.name),
          e('div',{className:'help'}, `Size: ${(d.size_bytes/1024).toFixed(2)} KB`),
          e('div',{className:'help'}, `Created: ${new Date(d.created_at).toLocaleString()}`)
        ))
      )
    );
  }

  // ---------- Jobs ----------
  function JobsView({client, apiOk, prefix}) {
    const [items,setItems] = useState([]);
    const [err,setErr] = useState('');
    useEffect(()=>{
      let timer;
      const load = async ()=>{
        setErr('');
        if (!apiOk || !prefix) return;
        try {
          const r = await client.jobs(); setItems(r?.jobs || []);
        } catch { setErr('Failed to load jobs'); }
      };
      load();
      timer = setInterval(load, 2000);
      return ()=> clearInterval(timer);
    }, [apiOk, prefix]);
    return e(React.Fragment, {},
      e('h2', null, 'Jobs'),
      err ? e('div',{className:'alert'}, err) : null,
      e('div',{className:'grid'},
        (items||[]).map(j=> e('div',{className:'card', key:j.job_id},
          e('div', {style:{fontWeight:800}}, j.job_id),
          e('div', null, `Status: ${j.status}`),
          e('div', {className:'help'}, `Progress: ${Math.round(j.progress)}%`)
        ))
      )
    );
  }

  // ---------- Verify ----------
  function VerifyView({client, apiOk, prefix}) {
    const [ode,setOde] = useState('');
    const [sol,setSol] = useState('');
    const [method,setMethod] = useState('substitution');
    const [res,setRes] = useState(null);
    const [err,setErr] = useState('');
    async function run() {
      setErr(''); setRes(null);
      try {
        const r = await client.auth.post(client.prefix + '/verify', {ode, solution: sol, method});
        setRes(r.data);
      } catch (e) { setErr(e?.response?.data?.detail || e.message || 'Verify failed'); }
    }
    return e(React.Fragment, {},
      e('h2', null, 'Verification'),
      err ? e('div',{className:'alert'}, err) : null,
      e('div',{className:'row'},
        e('div',{className:'field', style:{gridColumn:'span 12'}}, e('label',null,'ODE'), e('textarea',{value:ode, onChange:e=>setOde(e.target.value)})),
        e('div',{className:'field', style:{gridColumn:'span 12'}}, e('label',null,'Solution'), e('textarea',{value:sol, onChange:e=>setSol(e.target.value)})),
        e('div',{className:'field', style:{gridColumn:'span 3'}},
          e('label',null,'Method'),
          e('select',{value:method, onChange:e=>setMethod(e.target.value)},
            e('option',{value:'substitution'},'substitution'),
            e('option',{value:'numerical'},'numerical'),
            e('option',{value:'series'},'series')
          )
        )
      ),
      e('button',{className:'btn', onClick:run, disabled:!(ode&&sol)}, 'Verify'),
      res ? e('div',{className:'card', style:{marginTop:12}}, e('pre',null, JSON.stringify(res,null,2))) : null
    );
  }

  // ---------- Analytics (simple stub) ----------
  function AnalyticsView({client, apiOk, prefix}) {
    const [stats,setStats] = useState(null);
    useEffect(()=>{
      let cancelled=false;
      (async ()=>{
        if (!apiOk || !prefix) return;
        try { const r = await client.stats(); if (!cancelled) setStats(r); } catch {}
      })();
      return ()=>{cancelled=true;}
    }, [apiOk, prefix]);
    return e(React.Fragment, {},
      e('h2', null, 'Analytics'),
      !stats ? e('div',null,'Loadingâ€¦') : e('pre',null, JSON.stringify(stats,null,2))
    );
  }

  // ---------- ML (list models only) ----------
  function MLView() {
    return e(React.Fragment, {}, e('h2',null,'ML'), e('div',{className:'help'}, 'Use API endpoints for ML jobs.'));
  }

  // Mount
  ReactDOM.createRoot(document.getElementById('app')).render(e(App));
})();
</script>
</body>
</html>
